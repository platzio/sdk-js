name: ğŸš€ Publish SDK

on:
  push:
    branches:
      - main

jobs:
  release:
    name: ğŸš€ Publish SDK
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›ï¸ Checkout
        uses: actions/checkout@v3

      - name: ğŸ› ï¸ Setup node
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: ğŸ² Choose backend version
        id: backend_tag
        run: |
          if [ -f version-override.txt ]
          then
            echo "backend_tag=v`cat version-override.txt`" >> "$GITHUB_OUTPUT"
          else
            echo "backend_tag=v`cat package.json | jq -r .version`" >> "$GITHUB_OUTPUT"
          fi

      - name: â¬‡ï¸ Download OpenAPI schema
        uses: robinraju/release-downloader@v1.8
        with:
          repository: ${{ github.repository_owner }}/backend
          tag: ${{ steps.backend_tag.outputs.backend_tag }}
          fileName: "openapi.yaml"

      - name: ğŸ—ï¸ Generate SDK
        uses: craicoverflow/openapi-generator-action@v1
        with:
          generator: "typescript-axios"
          input: "openapi.yaml"
          output: "."
          additional-properties: useSingleRequestParameter=true

      - name: ğŸš€ Publish to NPM
        uses: JS-DevTools/npm-publish@v2
        with:
          token: ${{ secrets.NPM_TOKEN }}
